<!DOCTYPE html>

<!-- =========================================================
* Sneat - Bootstrap 5 HTML Admin Template - Pro | v1.0.0
==============================================================

* Product Page: https://themeselection.com/products/sneat-bootstrap-html-admin-template/
* Created by: ThemeSelection
* License: You must have a valid license purchased in order to legally use the theme for your project.
* Copyright ThemeSelection (https://themeselection.com)

=========================================================
 -->
<!-- beautify ignore:start -->
<html
  lang="en"
  class="light-style layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free"
>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <title>Dashboard - Analytics | Sneat - Bootstrap 5 HTML Admin Template - Pro</title>

    <meta name="description" content="" />
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- Icons. Uncomment required icon fonts -->
    <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="../assets/vendor/libs/apex-charts/apex-charts.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="../../assets/vendor/libs/typeahead-js/typeahead.css" />
    <link rel="stylesheet" href="../../assets/vendor/libs/select2/select2.css" />
    <link rel="stylesheet" href="../../assets/vendor/libs/tagify/tagify.css" />
    <link rel="stylesheet" href="../../assets/vendor/libs/bootstrap-select/bootstrap-select.css" />
    <link rel="stylesheet" href="../../assets/vendor/libs/spinkit/spinkit.css" />

    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="../assets/vendor/js/helpers.js"></script>

    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="../assets/js/config.js"></script>
    
    <style>
      #table-container {
            width: 100%;
            height: 250px;
            overflow-x: scroll;
            padding: 0;
        }

        #data-table {
            width: 100%;
            font-family: Arial, sans-serif;
            overflow-x: scroll;
        }

        #table-header th {
            padding: 5px;
            cursor: pointer;
        }

        #table-header th:hover {
            background: #b3b4f9be;
        }

        th,
        td {
            border: 1px solid rgb(236, 232, 232);
            padding: 5px;
            text-align: left;
            font-size: small;
        }
    </style>
  </head>

  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <%- include('./partials/sidebar.ejs') %>

        <!-- Layout container -->
        <div class="layout-page">
          <%- include('./partials/navbar.ejs') %>

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->

            <div class="container-xxl flex-grow-1 container-p-y">
                
              <div class="card mb-2">
                <div class="px-1 d-flex justify-content-between items-center">
                  <div class="w-50 py-0 px-1 d-flex justify-content-between items-center">
                    <div class="col-form-label">Base de données : <span class="p-1 bg-primary text-lowercase text-white rounded-1"><%= db_name %></span></div>
                    <button type="button" onclick="onDecoCluster()" class="btn btn-sm btn-warning m-1">Déconnexion</button>
                    <div class="col-form-label">Selectionner table : </div>
                  </div>

                  <div class="w-50 py-0 px-1 d-flex justify-content-between items-center">
                    <select
                      onchange="onSelectTable()"
                      id="selectLiveTableSearch"
                      class="selectpicker form-control-sm w-100"
                      data-style="btn-default"
                      data-live-search="true"
                    >
                      <option class="form-control-sm pb-0" value="" style="color: rgb(169, 165, 165);">Selectionner la table</option>
                      <% db_table.forEach(table=> { %>
                        <option class="form-control-sm pb-0" value="<%= table.table_name %>">
                            <%= table.table_name %>
                        </option>
                      <% }); %>   
                    </select>
                  </div>
                </div>
              </div>

              <div class="card mb-2">
                <div class="row m-2">
                  <div id="table-container" class="table-responsive text-nowrap">
                    <table id="data-table" class="table table-hover border-top">
                      <thead id="table-header" class="table-primary shadow-sm"></thead>
                      <tbody id="table-body" class="table-border-bottom-0"></tbody>
                      <div id="noSelectTab" class="text-center h1 p-5" style="min-height: 200px;">Pas de table selectionnée !</div>
                    </table>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="row m-2 mb-0">
                  <textarea  oninput="onWriteSQL()" placeholder="SELECT * FROM table_name;" class="form-control p-2" id="queryTextarea" rows="3"></textarea>
                </div>
                
                <div class="m-2">
                  <div id="accordionIcon" class="accordion accordion-without-arrow">
                    <div class="accordion-item bg-light">

                      <div class="accordion-header text-body d-flex justify-content-between items-center rounded-1" id="accordionIconOne">
                        <div class="card w-10">
                          <button
                            href="#resultQuery"
                            id="submitQuery" 
                            type="button"
                            class="collapsed btn btn-sm btn-primary m-1"
                            data-bs-toggle="collapse"
                            data-bs-target="#accordionIcon-1"
                            aria-controls="accordionIcon-1"
                            disabled
                            >
                              Exécuter Requête
                          </button>
                        </div>
                        <div id="check_syntax" class="text-end p-1"></div>
                      </div>

                      <div id="accordionIcon-1" class="accordion-collapse collapse show" data-bs-parent="#accordionIcon">
                        <div class="accordion-body px-0 py-2">
                          <div id="table-container" class="table-responsive text-nowrap">
                            <table id="data-table" class="table table-hover border-top">
                                <thead id="table-header-view" class="table-primary shadow-sm"></thead>
                                <tbody id="table-body-view" class="table-border-bottom-0"></tbody>
                                <div id="noViewTab" class="text-center h1 p-5" style="min-height: 200px;">
                                    <div class="d-flex justify-content-center">
                                        <div class="sk-bounce sk-primary">
                                            <div class="sk-bounce-dot"></div>
                                            <div class="sk-bounce-dot"></div>
                                        </div>
                                    </div>
                                </div>
                            </table>
                          </div>

                          <div class="rounded-1 mt-2">
                            <div class="row">
                              <div class="col-md-5">
                                <div class="form-check custom-option custom-option-basic border-0 shadow-sm">
                                  <label class="form-check-label custom-option-content pt-1 pb-0 rounded-1" for="savaCurrBD">
                                    <input name="customRadioTemp" class="form-check-input" type="radio" value="" id="savaCurrBD" checked/>
                                    <span class="custom-option-header">
                                      <span class="text-primary">Stocker dans la base de données actuelle !</span>
                                    </span>
                                  </label>

                                  <div class="custom-option-body px-3 pb-3 form-control-sm">
                                    <label for="tabName">Table</label>
                                    <input
                                      id="tabName"
                                      type="text"
                                      name="tabName"
                                      class="form-control form-control-sm px-2 container-xxl border-1"
                                      placeholder="nom de la table..."
                                      aria-label="nom de la table..."
                                    />
                                    <button type="button" class="btn btn-sm btn-primary mt-2" disabled>Valider</button>
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-7">
                                <div class="form-check custom-option custom-option-basic border-0 shadow-sm">
                                  <label class="form-check-label custom-option-content pt-1 pb-0 rounded-1" for="savaExtBD">
                                    <input name="customRadioTemp" class="form-check-input" type="radio" value="" id="savaExtBD"/>
                                    <span class="custom-option-header">
                                      <span class="text-primary">Stocker dans une autre base de données !</span>
                                    </span>
                                  </label>

                                  <div class="custom-option-body px-3 pb-3 form-control-sm">
                                    <div class="row">
                                      <div class="col-md-6">
                                        <label for="tabName">Table</label>
                                        <input
                                          id="tabName"
                                          type="text"
                                          name="tabName"
                                          class="form-control form-control-sm px-2 container-xxl border-1"
                                          placeholder="nom de la table..."
                                          aria-label="nom de la table..."
                                        />
                                      </div>
                                      <div class="col-md-6">
                                        <label for="tabName">Base de données</label>
                                        <select
                                          onchange="onSelectTable()"
                                          id="selectLiveTableSearch"
                                          class="selectpicker form-control form-control-sm"
                                          data-style="btn-default"
                                          data-live-search="true"
                                        >
                                          <option class="form-control-sm pb-0" value="" style="color: rgb(169, 165, 165);">Selectionner la base de données</option>
                                          <% db_table.forEach(table=> { %>
                                            <option class="form-control-sm pb-0" value="<%= table.table_name %>">
                                                <%= table.table_name %>
                                            </option>
                                          <% }); %>   
                                        </select>
                                      </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-primary mt-2" disabled>Valider</button>
                                  </div>
                                </div>
                              </div>
                            </div>


                            <!-- <div class="row">
                              <div class="col-lg-6">
                                <div class="card">
                                  <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        Hello
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="col-lg-6">
                                <div class="card">
                                  <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                      Hello
                                  </div>
                                  </div>
                                </div>
                              </div>
                            </div> -->
                          </div>

                          <div id="resultQuery"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- / Content -->

            <div class="content-backdrop fade"></div>
          </div>
          <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
      </div>

    </div>
    <!-- / Layout wrapper -->

    <!-- Core JS -->
    <!-- build:js assets/vendor/js/core.js -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>

    <script src="../assets/vendor/js/menu.js"></script>
    <!-- endbuild -->

    <!-- Vendors JS -->
    <script src="../../assets/vendor/libs/select2/select2.js"></script>
    <script src="../../assets/vendor/libs/tagify/tagify.js"></script>
    <script src="../../assets/vendor/libs/bootstrap-select/bootstrap-select.js"></script>
    <script src="../../assets/vendor/libs/typeahead-js/typeahead.js"></script>
    <script src="../../assets/vendor/libs/bloodhound/bloodhound.js"></script>

    <!-- Main JS -->
    <script src="../assets/js/main.js"></script>
    <!-- <script src="./scripts/requests.js"></script> -->

    <!-- Page JS -->
    <!-- <script src="../assets/js/dashboards-analytics.js"></script> -->
    <!-- <script src="../assets/js/forms-selects.js"></script> -->
    <!-- <script src="../assets/js/forms-tagify.js"></script> -->
    <!-- <script src="../assets/js/forms-typeahead.js"></script> -->

    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
  </body>

  <script>
    function onSelectTable() {
      tableName = { table_name: document.getElementById('selectLiveTableSearch').value }

      if (tableName.table_name !== '') {
        document.getElementById("noSelectTab").style.display = 'none';

        fetch('/data/getTableCluster', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'usr-auth-token': adminToken, },
          body: JSON.stringify(tableName),
        })
          .then(response => response.json())
          .then((data) => {
            if (data.table_data[0]) {
              const columns = Object.keys(data.table_data[0]);
              const tableHeader = `<tr>${columns.map(column => `<th>${column}</th>`).join('')}</tr>`;
              const tableRows = data.table_data.map(row => {
                return `<tr>${columns.map(column => `<td class="p-1">${row[column]}</td>`).join('')}</tr>`;
              }).join('');

              document.getElementById('table-header').innerHTML = tableHeader;
              document.getElementById('table-body').innerHTML = tableRows;

              const thElements = document.querySelectorAll('#table-header th');
              thElements.forEach(th => {
                th.addEventListener('click', () => {
                  const column = th.textContent;
                  addNewChar(tableName.table_name + `.` + column)
                });
              });
            }
            else {
              document.getElementById("#noSelectTab").style.display = 'flex';
            }
          })
          .catch(error => {
            console.error('Error submitting form:', error);
          });
      }
    }


    function addNewChar(character) {
      var textarea = document.getElementById('queryTextarea');
      var currentValue = textarea.value;
      var newValue = currentValue + " " + character;
      textarea.value = newValue;
    }


    let timeout;
    function onWriteSQL() {
      const sqlQueryArea = document.getElementById('queryTextarea');
      const checkSyntax = document.getElementById('check_syntax');
      const btnSubmitQuery = document.getElementById('submitQuery');
      checkSyntax.style.display = "none";

      clearTimeout(timeout);
      timeout = setTimeout(() => {
        if (sqlQueryArea.value.trim() !== '') {
          fetch('/data/check_query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sqlQuery: sqlQueryArea.value.trim() })
          })
            .then(response => response.json())
            .then((data) => {
              checkSyntax.style.display = "block";
              checkSyntax.textContent = data.check_value ? 'Requête SQL Valide !' : 'Requête SQL Invalide !';
              checkSyntax.style.color = data.check_value ? '#45a049' : '#fc2f18';
              btnSubmitQuery.disabled = data.check_value ? false : true;
            })
            .catch(error => {
              console.error('Error submitting form:', error);
            });
        } else {
          checkSyntax.style.display = "none";
          btnSubmitQuery.disabled = true;
        }
      }, "300");
    }


    $('#submitQuery').click(function () {
      var sectionTo = $(this).attr('href');
      $('html, body').animate({
        scrollTop: $(sectionTo).offset().top
      }, 200);
    });


    document.getElementById('submitQuery').addEventListener('click', () => {
      document.getElementById('accordionIcon-1').className = "accordion-collapse collapse show";
      let query_content = document.getElementById('queryTextarea').value;

      if (query_content.trim() !== '') {
        const dataQuery = {
          clusterId: `<%= clusterId %>`,
          queryContent: query_content.trim(),
          userId: adminData.id,
          database: `<%= db_name %>`
        }

        onPreviewQuery(dataQuery)
      }
      else {
        document.getElementById('check_syntax').style.color = '#fc2f18';
        document.getElementById('check_syntax').textContent = "Champ invalide !";
      }
    });


    function onPreviewQuery(dataQuery) {
      if (dataQuery) {
        fetch('/data/executeQuery', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'usr-auth-token': adminToken, },
          body: JSON.stringify(dataQuery),
        })
          .then(response => response.json())
          .then((data) => {
            if (data.table_data[0]) {
              document.getElementById("noViewTab").style.display = 'none';
              const columns = Object.keys(data.table_data[0]);
              const tableHeader = `<tr>${columns.map(column => `<th>${column}</th>`).join('')}</tr>`;

              const tableRows = data.table_data.map(row => {
                return `<tr>${columns.map(column => `<td class="p-1">${row[column]}</td>`).join('')}</tr>`;
              }).join('');

              document.getElementById('table-header-view').innerHTML = tableHeader;
              document.getElementById('table-body-view').innerHTML = tableRows;

              const thElements = document.querySelectorAll('#table-header-view th');
              thElements.forEach(th => {
                th.addEventListener('click', () => {
                  const column = th.textContent;
                  addNewChar(tableName.table_name + `.` + column)
                });
              });
            }
            else {
              document.getElementById("#noViewTab").style.display = 'flex';
            }
          })
          .catch(error => {
            console.error('Error submitting form:', error);
          });
      }
    }


    function onDecoCluster() {
      fetch('/data/logoutCluster', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'usr-auth-token': adminToken, },
        body: JSON.stringify({ clusterId: `<%= clusterId %>`, }),
      })
        .then(response => response.json())
        .then((data) => {
          if (data.config) { window.location.href = '/managedb'; }
        })
        .catch((error) => { console.log(error); });
    }
  </script>
</html>